<?xml version="1.0" encoding="utf-8"?>
<project name="tiapkss.single1" default="usage">
  <description>
    functional tiapkss single1 tests.

    @testlogic.group  type="working" values="true"  
    @testlogic.group type="install" values="full"
    @testlogic.group type="winFIPS" values="false"

  </description>

  <!-- ADDED-BY-SEED Absolute path to this file -->
  <dirname property="tiapkss.single1.dir" file="${ant.file.tiapkss.single1}" />

  <!-- ADDED-BY-SEED Import base file -->
  <import file="${tiapkss.single1.dir}/../tiapkss-test-base.xml" />

  <!-- =================================================== -->
  <!-- prepare -->
  <!-- =================================================== -->

  <target name="prepare" >
  <description>
     Remove any old logfiles lingering in T_WORK.
     Create and start a kss1 instance.
     Copy hello.html to htdocs of kss1.
  </description>
    <firsttimeonly>
     <delete>
        <fileset dir="${twork.dir}" includes="tiapkss_single1*"/>
     </delete>

    <!-- Create a new OHS instance -->
    <antcall target="createOHS">
      <param name="out.log"  value="tiapkss_single1_crt.log"/>
      <param name="ohs.name" value="kss1"/>
    </antcall>

    <!-- Copy hello world to htdocs -->
    <!-- No SSL configuration necessary as this is the default wallet -->
    <property name="htdocsDir" value="${ohsConfDir}/instances/kss1/htdocs"/>
    <copy file="${tiapkss.base.dir}/common/data/hello.html"
           todir="${htdocsDir}" />

    <!-- Start kss1 -->
    <antcall target="startOHS">
      <param name="out.log"  value="tiapkss_single1_start.log"/>
      <param name="ohs.name" value="kss1"/>
    </antcall>

    </firsttimeonly>
  </target>

  <!-- =================================================== -->
  <!-- unprepare -->
  <!-- =================================================== -->

  <target name="unprepare" >
  <description>
     Shutdown kss1 instance
  </description>
    <firsttimeonly>
    <trycatch>
    <try>
      <antcall target="stopOHS">
        <param name="out.log"  value="tiapkss_single1_stop.log"/>
        <param name="ohs.name" value="kss1"/>
      </antcall>
    </try>
    </trycatch>
    </firsttimeonly>
  </target>

  <!-- =================================================== -->
  <!-- suite -->
  <!-- =================================================== -->

  <target name="suite">
    <description>
       Tests to check out the default OHS wallet "default" with KSS.
    </description>

    <!-- Initial validation of certs in default OHS wallet -->
    <antcall target="chkDef"/>

    <!-- KSS:  validate default KSS keystore, then add three certs -->
    <!-- and export to the OHS wallet -->
    <antcall target="exp1"/>

    <!-- Validate update of the OHS wallet -->
    <antcall target="val1"/>

    <!-- Bounce & ping OHS -->
    <antcall target="ping1"/>

    <!-- KSS:  delete two certs and then export to the wallet -->
    <antcall target="exp2"/>

    <!-- Verify OHS wallet has been updated -->
    <antcall target="val2"/>

    <!-- Bounce & ping OHS -->
    <antcall target="ping2"/>

  </target>

  <!-- =================================================== -->
  <target name="chkDef">
  <description>
     Verify contents of default OHS wallet
  </description>

    <property name="tstName" value="tiapkss_single1_chkDef"/>
    <property name="ohsName" value="kss1"/>
    <property name="defDir"
     value="${ohsConfDir}/instances/${ohsName}/keystores/default"/>
    <property name="defWallet" value="${defDir}/cwallet.sso"/>

    <!-- Run:  orapki wallet display -wallet . -->
    <antcall target="oraDisplay">
      <param name="out.log"    value="${tstName}.out"/>
      <param name="walletPath" value="${defDir}"/>
    </antcall>

    <!-- Compare orapki output with goldfile -->
    <property name="goldFile" value="${twork.dir}/${tstName}.gold"/>
    <copy file="${gold.path}/single1_chkDef.gold"
        tofile="${goldFile}"/>
    <antcall target="wlstFindStr">
      <param name="logfile"  value="${tstName}.out"/>
      <param name="goldfile" value="${goldFile}"/>
      <param name="outfile"  value="${tstName}.log"/>
    </antcall>
  </target>

  <!-- =================================================== -->
  <target name="exp1">
  <description>
     Run script to add certs and export default KSS to wallet
  </description>
    <property name="tstName" value="tiapkss_single1_exp1"/>
    <property name="scriptDir"  value="${team.base.dir}/common/wlst"/>
    <property name="goldFile" value="${twork.dir}/${tstName}.gold"/>
    <copy file="${gold.path}/single1_exp1.gold"
        tofile="${goldFile}"/>

    <!-- Run the script -->
    <antcall target="wlstRunScript">
      <param name="script"  value="${scriptDir}/single1_exp1.py"/>
      <param name="ohsName" value="kss1"/>
      <param name="outfile" value="${tstName}.out"/>
    </antcall>
   
    <!-- Check script output vs. expected results -->
    <antcall target="wlstCompareLogs">
      <param name="logfile"  value="${tstName}.out"/>
      <param name="goldfile" value="${tstName}.gold"/>
      <param name="outfile"  value="${tstName}.log"/>
    </antcall>
  </target>

  <!-- =================================================== -->
  <target name="val1">
  <description>
     Validate OHS wallet has been updated
  </description>
    <property name="tstName" value="tiapkss_single1_val1"/>
    <property name="ohsName" value="kss1"/>
    <property name="defDir"
     value="${ohsConfDir}/instances/${ohsName}/keystores/default"/>
    <property name="defWallet" value="${defDir}/cwallet.sso"/>

    <!-- Run:  orapki wallet display -wallet . -->
    <antcall target="oraDisplay">
      <param name="out.log"    value="${tstName}.out"/>
      <param name="walletPath" value="${defDir}"/>
    </antcall>

    <!-- Compare orapki output with goldfile -->
    <property name="goldFile" value="${twork.dir}/${tstName}.gold"/>
    <copy file="${gold.path}/single1_val1.gold"
        tofile="${goldFile}"/>
    <antcall target="wlstFindStr">
      <param name="logfile"  value="${tstName}.out"/>
      <param name="goldfile" value="${goldFile}"/>
      <param name="outfile"  value="${tstName}.log"/>
    </antcall>

  </target>

  <!-- =================================================== -->
  <target name="ping1">
  <description>
    First ping after export
  </description>
     <antcall target="pingKSS">
       <param name="tstName" value="tiapkss_single1_ping1"/>
       <param name="ohsName" value="kss1"/>
     </antcall>
  </target>
  
  <!-- =================================================== -->
  <target name="exp2">
  <description>
     Run script to delete two certs and export to OHS
  </description>
    <property name="tstName" value="tiapkss_single1_exp2"/>
    <property name="scriptDir"  value="${team.base.dir}/common/wlst"/>
    <property name="goldFile" value="${twork.dir}/${tstName}.gold"/>
    <copy file="${gold.path}/single1_exp2.gold"
        tofile="${goldFile}"/>

    <!-- Run the script -->
    <antcall target="wlstRunScript">
      <param name="script"  value="${scriptDir}/single1_exp2.py"/>
      <param name="ohsName" value="kss1"/>
      <param name="outfile" value="${tstName}.out"/>
    </antcall>

    <!-- Check script output vs. expected results -->
    <antcall target="wlstCompareLogs">
      <param name="logfile"  value="${tstName}.out"/>
      <param name="goldfile" value="${tstName}.gold"/>
      <param name="outfile"  value="${tstName}.log"/>
    </antcall>
  </target>

  <!-- =================================================== -->
  <target name="val2">
  <description>
     Validate OHS wallet has been updated
  </description>
    <property name="tstName" value="tiapkss_single1_val2"/>
    <property name="ohsName" value="kss1"/>
    <property name="defDir"
     value="${ohsConfDir}/instances/${ohsName}/keystores/default"/>
    <property name="defWallet" value="${defDir}/cwallet.sso"/>

    <!-- Run:  orapki wallet display -wallet . -->
    <antcall target="oraDisplay">
      <param name="out.log"    value="${tstName}.out"/>
      <param name="walletPath" value="${defDir}"/>
    </antcall>

    <!-- Compare orapki output with goldfile -->
    <property name="goldFile" value="${twork.dir}/${tstName}.gold"/>
    <copy file="${gold.path}/single1_val2.gold"
        tofile="${goldFile}"/>
    <antcall target="wlstFindStr">
      <param name="logfile"  value="${tstName}.out"/>
      <param name="goldfile" value="${goldFile}"/>
      <param name="outfile"  value="${tstName}.log"/>
    </antcall>

  </target>

  <!-- =================================================== -->
  <target name="ping2">
  <description>
     Ping after second export
  </description>
     <antcall target="pingKSS">
       <param name="tstName" value="tiapkss_single1_ping2"/>
       <param name="ohsName" value="kss1"/>
     </antcall>
  </target>
  
</project>

 
