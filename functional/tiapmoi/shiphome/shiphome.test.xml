<?xml version="1.0" encoding="utf-8"?>
<project name="tiapmoi.shiphome" default="usage">
  <description>
    functional tiapmoi shiphome tests.

    @testlogic.group  type="working" values="true"
    @testlogic.group type="install"  values="restricted,compact,full"
    @testlogic.group type="winFIPS" values="false"

  </description>

  <!-- ADDED-BY-SEED Absolute path to this file -->
  <dirname property="tiapmoi.shiphome.dir" file="${ant.file.tiapmoi.shiphome}" />

  <!-- ADDED-BY-SEED Import base file -->
  <import file="${tiapmoi.shiphome.dir}/../tiapmoi-test-base.xml" />

  <!-- =================================================== -->
  <!-- prepare -->
  <!-- =================================================== -->

  <target name="prepare" >
  <description>
     Remove any old logfiles lingering in T_WORK
  </description>
    <firsttimeonly>
     <delete>
        <fileset dir="${twork.dir}" includes="tiapmoi_shiphome*"/>
     </delete>
    </firsttimeonly>
  </target>

  <!-- =================================================== -->
  <!-- suite -->
  <!-- =================================================== -->

  <target name="suite">
    <description>
       Shiphome tests.  Verify shiphome contains expected bits.
    </description>
  
    <!-- Scan $ORACLE_HOME/ohs/bin fileset -->
    <antcall target="verify01"/>

    <!-- Scan $ORACLE_HOME/ohs/templates/conf fileset -->
    <antcall target="verify02"/>

    <!-- Scan $ORACLE_HOME/ohs/lib fileset -->
    <antcall target="verify03"/>  
 
    <!-- Verify behavior of createOHSInstance if no conf directory -->
    <antcall target="missingConf"/>
  
  </target>

  <!-- =================================================== -->
  <!-- verify01 -->
  <!-- =================================================== -->
  <target name="verify01">
  <description>
     Verify $ORACLE_HOME/ohs/bin contains expected bits
  </description>

    <property name="tstName"   value="tiapmoi_shiphome_verify01"/>
    <property name="goldfile"  value="${tstName}.gold"/>
    <copy file="${gold.path}/ohs.binaries.gold" 
         tofile="${twork.dir}/${goldfile}"/>

    <antcall target="scanDir">
      <param name="action" value="ohs_bin"/>
      <param name="outfile" value="${tstName}.out"/>
    </antcall>
    <antcall target="compareFiles">
      <param name="goldfile" value="${goldfile}"/>
      <param name="testfile" value="${tstName}.out"/>
      <param name="outfile" value="${tstName}.log"/>
    </antcall>

  </target>

  <!-- =================================================== -->
  <!-- verify02 -->
  <!-- =================================================== -->
  <target name="verify02">
  <description>
     Verify $ORACLE_HOME/ohs/templates/conf contains expected bits
  </description>

    <property name="tstName"   value="tiapmoi_shiphome_verify02"/>
    <property name="goldfile"  value="${tstName}.gold"/>
    <copy file="${gold.path}/ohs.templates.gold" 
         tofile="${twork.dir}/${goldfile}"/>

    <antcall target="scanDir">
      <param name="action" value="ohs_conf"/>
      <param name="outfile" value="${tstName}.out"/>
    </antcall>
    <antcall target="compareFiles">
      <param name="goldfile" value="${goldfile}"/>
      <param name="testfile" value="${tstName}.out"/>
      <param name="outfile" value="${tstName}.log"/>
    </antcall>

  </target>

  <!-- =================================================== -->
  <!-- verify03 -->
  <!-- =================================================== -->
  <target name="verify03">
  <description>
     Verify $ORACLE_HOME/ohs/lib contains expected bits
  </description>

    <property name="tstName"   value="tiapmoi_shiphome_verify03"/>
    <property name="goldfile"  value="${tstName}.gold"/>
    <copy file="${gold.path}/ohs.lib.gold" 
         tofile="${twork.dir}/${goldfile}"/>

    <antcall target="scanDir">
      <param name="action" value="ohs_lib"/>
      <param name="outfile" value="${tstName}.out"/>
    </antcall>
    <antcall target="compareFiles">
      <param name="goldfile" value="${goldfile}"/>
      <param name="testfile" value="${tstName}.out"/>
      <param name="outfile" value="${tstName}.log"/>
    </antcall>

  </target>

  <!-- =================================================== -->
  <!-- missingConf -->
  <!-- =================================================== -->
  <target name="missingConf">
  <description>
     Verify behavior of createOHSInstance if conf directory
     is missing from the ORACLE_HOME.  Apparently this can happen
     with a bad installation of the shiphome.
  </description>

  <property name="conf.dir"  value="${ORACLE_HOME}/ohs/templates/conf"/>
  <property name="conf1.dir" value="${conf.dir}1"/>
  <property name="tstName"   value="tiapmoi_shiphome_missingConf"/>
  <property name="ohsName"   value="missConf"/>
  <property name="gold.file"  value="${gold.genpath}/missingConf.gold"/>

  <!-- Temporarily move the conf dir -->
  <move file="${conf.dir}" tofile="${conf1.dir}"/>
 
  <!-- Attempt to create an OHS instance -->
  <antcall target="createOHS">
    <param name="out.log"  value="${tstName}1_crt.out"/>
    <param name="ohs.name" value="${ohsName}"/>
  </antcall>

  <!-- Restore the conf directory -->
  <!-- restore immediately as ant can error out here... -->
  <move file="${conf1.dir}" tofile="${conf.dir}"/>

  <!-- Scan logfile for the expected error message -->
  <antcall target="wlstFindStr">
    <param name="logfile" value="${tstName}1_crt.out"/>
    <param name="goldfile" value="${gold.file}"/>
    <param name="outfile"  value="${tstName}1_crt.log"/>
  </antcall>

  <!-- Verify we can create / delete instances afterwards -->
  <antcall target="createOHS">
    <param name="out.log"  value="${tstName}2_crt.out"/>
    <param name="ohs.name" value="${ohsName}"/>
  </antcall>

  <antcall target="wlstErrorScan">
    <param name="in.file" value="${tstName}2_crt.out"/>
    <param name="out.file" value="${tstName}2_crt.log"/>
  </antcall>

  <antcall target="deleteOHS">
    <param name="out.log"  value="${tstName}2_del.log"/>
    <param name="ohs.name" value="${ohsName}"/>
  </antcall>
 </target>

</project>

 
