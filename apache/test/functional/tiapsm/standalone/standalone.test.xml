<?xml version="1.0" encoding="utf-8"?>
<project name="tiapsm.standalone" default="usage">
  <description>
    functional tiapsm standalone tests.

    @testlogic.group  type="working" values="true"
    @testlogic.group type="category" values="mats"
    @testlogic.group type="install"  values="standalone"
    @testlogic.group type="winFIPS" values="false"

  </description>

  <!-- ADDED-BY-SEED Absolute path to this file -->
  <dirname property="tiapsm.standalone.dir" file="${ant.file.tiapsm.standalone}" />

  <!-- ADDED-BY-SEED Import base file -->
  <import file="${tiapsm.standalone.dir}/../tiapsm-test-base.xml" />

  <target name="suite">
    <description>
       Standalone smoke tests - verify basic OHS functionality
       This test is run as part of MATS.  Should any one test fail,
       exit the suite immediately.
    </description>

    <!-- Verify expected fileset for OHS instance -->
    <antcall target="createChkFiles"/>

    <!-- Start standalone -->
    <antcall target="start"/>

    <!-- Ping standalone -->
    <antcall target="ping"/>
    <antcall target="pingSSL"/>

    <!-- Shutdown standalone -->
    <antcall target="stop"/>

  </target>

  <!-- =================================================== -->
  <!-- createChkFiles -->
  <!-- =================================================== -->
  <target name="createChkFiles" >
  <description> 
     Minimal check to ensure expected OHS file suite was
     provisioned when create operation is run.
  </description>

     <tl-exec name="createChkFiles" executable="perl"
         cmdfile="${twork.dir}/tmp.txt"
         output="${twork.dir}/tiapsm_standalone_createChkFiles.log"
         failonerror="true">
         <arg line="${team.base.dir}/common/tiapsm.pl" />
         <arg line="chkCreate" />
         <arg line="smoke" />
         <env key="T_WORK"       value="${twork.dir}" />
         <env key="INSTALL_TYPE" value="${INSTALL_TYPE}" />
         <env key="ohsConfDir"   value="${ohsConfDir}" />
         <env key="ohsLogDir"    value="${ohsLogDir}" />
         <env key="nmLogDir"     value="${nmLogDir}" />
     </tl-exec>
     <antcall target="chkSmokeFail"/>

  </target>

  <!-- =================================================== -->
  <!-- start -->
  <!-- =================================================== -->
  
  <target name="start" >
  <description>
     @testlogic.requires tests="createChkFiles"
     Start the standalone instance and check for errors.
  </description>
  
     <!-- Copy hello world to smoke htdocs -->
     <property name="htdocsDir" value="${ohsConfDir}/instances/smoke/htdocs"/>
     <copy file="${tiapsm.base.dir}/common/tiapsm_smoke.html"
           todir="${htdocsDir}" />

     <!-- Setup standalone for SSL -->
     <antcall target="configureSSL">
        <param name="ohs.name" value="smoke"/>
        <param name="out.log" value="tiapsm_standalone_configureSSL.log"/>
     </antcall>
 
     <!-- Perform the start command -->
     <antcall target="startOHS"> 
        <param name="out.log"  value="tiapsm_standalone_start.out"/>
        <param name="ohs.name" value="smoke"/>
     </antcall>

     <!-- Scan the start output for errors -->
     <tl-exec name="scanStartLog" executable="perl"
           cmdfile="${twork.dir}/tmp.txt"
           output="${twork.dir}/tiapsm_standalone_start.log"
           failonerror="true">
           <arg line="${team.base.dir}/common/tiapsm.pl" />
           <arg line="scanLog" />
           <arg line="smoke" />
           <arg line="${twork.dir}/tiapsm_standalone_start.out" />
           <env key="T_WORK"       value="${twork.dir}" />
           <env key="INSTALL_TYPE" value="${INSTALL_TYPE}" />
      </tl-exec>
      <antcall target="chkSmokeFail"/>

  </target>

  <!-- =================================================== -->
  <!-- ping --> 
  <!-- =================================================== -->
  
  <target name="ping" >
  <description>
     @testlogic.requires tests="start"
     Verify OHS is up with basic http request.
  </description>

    <!-- Send the ping -->
      <antcall target="pingOHS">
        <param name="out.log"  value="tiapsm_standalone_ping.log"/>
        <param name="ohs.name" value="smoke"/>
        <param name="url"      value="/tiapsm_smoke.html"/>
      </antcall>

    <antcall target="chkSmokeFail"/>

  </target>

  <!-- =================================================== -->
  <!-- pingSSL --> 
  <!-- =================================================== -->
  
  <target name="pingSSL" >
  <description>
     @testlogic.requires tests="ping"
     Verify OHS is up with basic https request.
  </description>

    <!-- Send the ping -->
    <antcall target="pingOHS_ssl">
        <param name="out.log"  value="tiapsm_standalone_pingSSL.log"/>
        <param name="ohs.name" value="smoke"/>
        <param name="url"      value="/tiapsm_smoke.html"/>
    </antcall>
    <antcall target="chkSmokeFail"/>
  </target>


  <!-- =================================================== -->
  <!-- stop --> 
  <!-- =================================================== -->
  <target name="stop" >
  <description>
     @testlogic.requires tests="pingSSL"
     Stop the standalone instance.  Verify no errors take place.
  </description>

     <!-- Perform the stop command -->
     <antcall target="stopOHS">
        <param name="out.log"  value="tiapsm_standalone_stop.out"/>
        <param name="ohs.name" value="smoke"/>
     </antcall>

     <!-- Scan the stop output for errors -->
     <tl-exec name="scanStopLog" executable="perl"
           cmdfile="${twork.dir}/tmp.txt"
           output="${twork.dir}/tiapsm_standalone_stop.log"
           failonerror="true">
           <arg line="${team.base.dir}/common/tiapsm.pl" />
           <arg line="scanLog" />
           <arg line="smoke" />
           <arg line="${twork.dir}/tiapsm_standalone_stop.out" />
           <env key="T_WORK"       value="${twork.dir}" />
           <env key="INSTALL_TYPE" value="${INSTALL_TYPE}" />
      </tl-exec>
      <antcall target="chkSmokeFail"/>

  </target>

</project>

 
