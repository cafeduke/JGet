<?xml version="1.0" encoding="utf-8"?>
<project name="tiapsm.smoke" default="usage">
  <description>
    functional tiapsm smoke tests.

    @testlogic.group  type="working" values="true"  
    @testlogic.group type="category" values="mats"
    @testlogic.group type="install"  values="restricted,compact,full"
    @testlogic.group type="winFIPS" values="false"

  </description>

  <!-- ADDED-BY-SEED Absolute path to this file -->
  <dirname property="tiapsm.smoke.dir" file="${ant.file.tiapsm.smoke}" />

  <!-- ADDED-BY-SEED Import base file -->
  <import file="${tiapsm.smoke.dir}/../tiapsm-test-base.xml" />

  <target name="suite">
    <description>
       Smoke tests - verify basic OHS functionality
       This test is run as part of MATS.  Should any one test fail,
       exit the suite immediately.
    </description>

    <!-- Create an OHS instance: smoke -->
    <antcall target="create"/>
    <antcall target="createChkFiles"/>

    <!-- Start smoke -->
    <antcall target="start"/>

    <!-- Ping smoke -->
    <antcall target="ping"/>
    <antcall target="pingSSL"/>

    <!-- Shutdown smoke -->
    <antcall target="stop"/>

    <!-- Delete smoke -->
    <antcall target="delete"/>
    <antcall target="deleteChkFiles"/>

  </target>

  <!-- =================================================== -->
  <!-- create -->
  <!-- =================================================== -->
  <target name="create">
  <description>
     Create an OHS instance: smoke, and check if any
     exceptions or errors are returned in the output.
  </description>
     
     <!-- Create smoke instance -->
     <antcall target="createOHS">
        <param name="out.log"  value="tiapsm_smoke_create.out"/>
        <param name="ohs.name" value="smoke"/>
     </antcall>
 
     <!-- Scan the create output for errors --> 
     <tl-exec name="scanCreateLog" executable="perl"
           cmdfile="${twork.dir}/tmp.txt"
           output="${twork.dir}/tiapsm_smoke_create.log"
           failonerror="true">
           <arg line="${team.base.dir}/common/tiapsm.pl" />
           <arg line="scanLog" />
           <arg line="smoke" />
           <arg line="${twork.dir}/tiapsm_smoke_create.out" />
           <env key="T_WORK"       value="${twork.dir}" />
           <env key="INSTALL_TYPE" value="${INSTALL_TYPE}" />
      </tl-exec>
      <antcall target="chkSmokeFail"/>
      
  </target>

  <!-- =================================================== -->
  <!-- createChkFiles -->
  <!-- =================================================== -->
  <target name="createChkFiles" >
  <description> 
     @testlogic.requires tests="create"  
     Minimal check to ensure expected OHS file suite was
     provisioned when create operation is run.
  </description>

     <tl-exec name="createChkFiles" executable="perl"
         cmdfile="${twork.dir}/tmp.txt"
         output="${twork.dir}/tiapsm_smoke_createChkFiles.log"
         failonerror="true">
         <arg line="${team.base.dir}/common/tiapsm.pl" />
         <arg line="chkCreate" />
         <arg line="smoke" />
         <env key="T_WORK"       value="${twork.dir}" />
         <env key="INSTALL_TYPE" value="${INSTALL_TYPE}" />
         <env key="ohsConfDir"   value="${ohsConfDir}" />
         <env key="ohsLogDir"    value="${ohsLogDir}" />
         <env key="nmLogDir"     value="${nmLogDir}" />
     </tl-exec>
     <antcall target="chkSmokeFail"/>

  </target>

  <!-- =================================================== -->
  <!-- start -->
  <!-- =================================================== -->
  
  <target name="start" >
  <description>
     @testlogic.requires tests="create,createChkFiles"
     Start the smoke instance and check for errors.
  </description>
  
     <!-- Copy hello world to smoke htdocs -->
     <property name="htdocsDir" value="${ohsConfDir}/instances/smoke/htdocs"/>
     <copy file="${tiapsm.base.dir}/common/tiapsm_smoke.html"
           todir="${htdocsDir}" />

     <!-- Setup smoke for SSL -->
     <antcall target="configureSSL">
        <param name="ohs.name" value="smoke"/>
        <param name="out.log" value="tiapsm_smoke_configureSSL.log"/>
     </antcall>
 
     <!-- Perform the start command -->
     <antcall target="startOHS"> 
        <param name="out.log"  value="tiapsm_smoke_start.out"/>
        <param name="ohs.name" value="smoke"/>
     </antcall>

     <!-- Scan the start output for errors -->
     <tl-exec name="scanStartLog" executable="perl"
           cmdfile="${twork.dir}/tmp.txt"
           output="${twork.dir}/tiapsm_smoke_start.log"
           failonerror="true">
           <arg line="${team.base.dir}/common/tiapsm.pl" />
           <arg line="scanLog" />
           <arg line="smoke" />
           <arg line="${twork.dir}/tiapsm_smoke_start.out" />
           <env key="T_WORK"       value="${twork.dir}" />
           <env key="INSTALL_TYPE" value="${INSTALL_TYPE}" />
      </tl-exec>
      <antcall target="chkSmokeFail"/>

  </target>

  <!-- =================================================== -->
  <!-- ping --> 
  <!-- =================================================== -->
  
  <target name="ping" >
  <description>
     @testlogic.requires tests="create,start"
     Verify OHS is up with basic http request.
  </description>

    <!-- Send the ping -->
      <antcall target="pingOHS">
        <param name="out.log"  value="tiapsm_smoke_ping.log"/>
        <param name="ohs.name" value="smoke"/>
        <param name="url"      value="/tiapsm_smoke.html"/>
      </antcall>

    <antcall target="chkSmokeFail"/>

  </target>

  <!-- =================================================== -->
  <!-- pingSSL --> 
  <!-- =================================================== -->
  
  <target name="pingSSL" >
  <description>
     @testlogic.requires tests="create,start,ping"
     Verify OHS is up wtih basic https request.
  </description>

    <!-- Send the ping -->
    <antcall target="pingOHS_ssl">
        <param name="out.log"  value="tiapsm_smoke_pingSSL.log"/>
        <param name="ohs.name" value="smoke"/>
        <param name="url"      value="/tiapsm_smoke.html"/>
    </antcall>
    <antcall target="chkSmokeFail"/>
  </target>


  <!-- =================================================== -->
  <!-- stop --> 
  <!-- =================================================== -->
  <target name="stop" >
  <description>
     @testlogic.requires tests="create,start,ping,pingSSL"
     Stop the smoke instance.  Verify no errors take place.
  </description>

     <!-- Perform the stop command -->
     <antcall target="stopOHS">
        <param name="out.log"  value="tiapsm_smoke_stop.out"/>
        <param name="ohs.name" value="smoke"/>
     </antcall>

     <!-- Scan the stop output for errors -->
     <tl-exec name="scanStopLog" executable="perl"
           cmdfile="${twork.dir}/tmp.txt"
           output="${twork.dir}/tiapsm_smoke_stop.log"
           failonerror="true">
           <arg line="${team.base.dir}/common/tiapsm.pl" />
           <arg line="scanLog" />
           <arg line="smoke" />
           <arg line="${twork.dir}/tiapsm_smoke_stop.out" />
           <env key="T_WORK"       value="${twork.dir}" />
           <env key="INSTALL_TYPE" value="${INSTALL_TYPE}" />
      </tl-exec>
      <antcall target="chkSmokeFail"/>

  </target>

  <!-- =================================================== -->
  <!-- deleteSmoke --> 
  <!-- =================================================== -->

  <target name="delete" >
  <description>
     @testlogic.requires tests="create,start,stop"
     Delete the smoke instance and scan output log for errors.
  </description>

    <!-- Perform the delete command -->
     <antcall target="deleteOHS">
        <param name="out.log"  value="tiapsm_smoke_delete.out"/>
        <param name="ohs.name" value="smoke"/>
     </antcall>

     <!-- Scan output from delete operation for errors -->
     <tl-exec name="scanDeleteLog" executable="perl"
           cmdfile="${twork.dir}/tmp.txt"
           output="${twork.dir}/tiapsm_smoke_delete.log"
           failonerror="true">
           <arg line="${team.base.dir}/common/tiapsm.pl" />
           <arg line="scanLog" />
           <arg line="smoke" />
           <arg line="${twork.dir}/tiapsm_smoke_delete.out" />
           <env key="T_WORK"       value="${twork.dir}" />
           <env key="INSTALL_TYPE" value="${INSTALL_TYPE}" />
      </tl-exec>
      <antcall target="chkSmokeFail"/>

  </target>

  <!-- =================================================== -->
  <!-- deleteChkFiles -->
  <!-- =================================================== -->

  <target name="deleteChkFiles" >
  <description>
     @testlogic.requires tests="delete"
     Scan the ORACLE_HOME to confirm the removal operation is
     taking place as expected. OHS configuration files, logs, and
     state information should be removed.
  </description>

    <tl-exec name="deleteChkFiles" executable="perl"
       cmdfile="${twork.dir}/tmp.txt"
       output="${twork.dir}/tiapsm_smoke_deleteChkFiles.log"
       failonerror="true">
       <arg line="${team.base.dir}/common/tiapsm.pl" />
       <arg line="chkRemove" />
       <arg line="smoke" />
       <env key="T_WORK"       value="${twork.dir}" />
       <env key="INSTALL_TYPE" value="${INSTALL_TYPE}" />
       <env key="ohsConfDir"   value="${ohsConfDir}" />
       <env key="ohsLogDir"    value="${ohsLogDir}" />
       <env key="nmLogDir"     value="${nmLogDir}" />
     </tl-exec>
     <antcall target="chkSmokeFail"/>

  </target>
  
</project>

 
