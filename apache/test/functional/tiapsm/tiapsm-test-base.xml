<?xml version="1.0"?>
<project name="test.tiapsm.base">
  <description>
   Base file of all tiapsm tests.
  </description>

  <!-- ADDED-BY-SEED Absolute path to this file -->
  <dirname property="test.tiapsm.base.dir" file="${ant.file.test.tiapsm.base}" />

  <!-- ADDED-BY-SEED Import tiapsm base file -->
  <import file="${test.tiapsm.base.dir}/tiapsm-base.xml" />

  <!-- Import TLR core to run with TestLogic -->
  <import file="${testtool.3rdparty.testlogic.dir}/tlr-core-root.xml"/>

  <!-- ADDED-BY-SEED Import common test file targets -->
  <import file="${tl.cafe.file}"/>

  <!-- ====================================================================
    START: ADDED-BY-SEED Template generated code. Don't edit
   ===================================================================== -->
  <sequential>
    <!--
      Runs setup if it's neven been run. This is to help users to come to
      any test file and just run the target. Setup is run, if it's neven
      been run.
     -->

    <if>
      <not><available file="${team.setup.marker.file}"/></not>
      <then>
        <ant antfile="${team.base.dir}/build.xml"
             target="setup"
        />
      </then>
    </if>

  </sequential>
  <!-- ====================================================================
    END: ADDED-BY-SEED: Template generated code. Don't edit
   ===================================================================== -->

  <!-- Common validate for all tiapsm tests -->

  <!-- =================================================== -->
  <!-- prepare -->
  <!-- =================================================== -->

  <target name="prepare" >
  <description>
     Remove any old logfiles lingering in T_WORK
  </description>
    <firsttimeonly>
     <delete file="${twork.dir}/SMOKE_FAIL.dif" />
     <delete>
        <fileset dir="${twork.dir}" includes="tiapsm*"/>
     </delete>
   
     <!-- If smoke is already running, stop it automatically -->
     <trycatch>
     <try>
       <!-- Check to see if any smoke pids are running -->
       <antcall target="chkPids">
         <param name="pidName"  value="httpd.worker"/>
         <param name="expected" value="0"/>
         <param name="outfile"  value="smoke_expected.log"/>
         <param name="ohsName"  value="smoke"/>
       </antcall>
     </try>
     <catch>
        <!-- We didn't find zero pids, so stop smoke -->
        <antcall target="stopOHS">
          <param name="out.log"  value="smoke_stop.log"/>
          <param name="ohs.name" value="smoke"/>
        </antcall>
     </catch>
     </trycatch>

    </firsttimeonly>
  </target>

  <!-- =================================================== -->
  <!-- chkSmokeFail -->
  <!-- =================================================== -->

  <target name="chkSmokeFail" >
  <description>
     If we find a SMOKE_FAIL.dif in T_WORK, trigger a failure.
     All smoke tests will fail out calling this routine.
  </description>

    <property name="smoke.dif.file" value="${twork.dir}/SMOKE_FAIL.dif" />
    <property name="prettyLine" value="${line.separator}*****************************************${line.separator}"/>
    <property name="exit.msg"  value="${prettyLine}SMOKE_FAIL.dif found in T_WORK!${line.separator}The smoke tests have failed.${line.separator}Please triage all difs before re-running the tests.${line.separator}Exiting...${prettyLine}"/>

    <assertTrue message="${exit.msg}">
      <not><available file="${smoke.dif.file}"/></not>
    </assertTrue>
  </target>


</project>
