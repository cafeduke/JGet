<?xml version="1.0"?>
<project name="test.tiapcp.base">
  <description>
   Base file of all tiapcp tests.
  </description>

  <!-- ADDED-BY-SEED Absolute path to this file -->
  <dirname property="test.tiapcp.base.dir" file="${ant.file.test.tiapcp.base}" />

  <!-- ADDED-BY-SEED Import tiapcp base file -->
  <import file="${test.tiapcp.base.dir}/tiapcp-base.xml" />

  <!-- Import TLR core to run with TestLogic -->
  <import file="${testtool.3rdparty.testlogic.dir}/tlr-core-root.xml"/>

  <!-- ADDED-BY-SEED Import common test file targets -->
  <import file="${tl.cafe.file}"/>

  <!-- ====================================================================
    START: ADDED-BY-SEED Template generated code. Don't edit
   ===================================================================== -->
  <sequential>
    <!--
      Runs setup if it's neven been run. This is to help users to come to
      any test file and just run the target. Setup is run, if it's neven
      been run.
     -->

    <if>
      <not><available file="${team.setup.marker.file}"/></not>
      <then>
        <ant antfile="${team.base.dir}/build.xml"
             target="setup"
        />
      </then>
    </if>

  </sequential>
  <!-- ====================================================================
    END: ADDED-BY-SEED: Template generated code. Don't edit
   ===================================================================== -->

  <!-- Common validate for all tiapcp tests -->

  <!-- =================================================== -->
  <!-- prepare -->
  <!-- =================================================== -->

  <target name="prepare" >
  <description>
     Remove any old logfiles lingering in T_WORK
  </description>
     <firsttimeonly>
       <delete>
          <fileset dir="${twork.dir}" includes="tiapcp*"/>
       </delete>
     </firsttimeonly>

     <!-- Create an OHS instance to use -->
     <antcall target="createOHS">
        <param name="out.log"  value="tiapcp_cattleprod_create.log"/>
        <param name="ohs.name" value="cp1"/>
     </antcall>

     <antcall target="setupCattleprod"/>

     <!-- Start OHS -->
     <antcall target="startOHS">
       <param name="out.log" value="tiapcp_cattleprod_start.log"/>
       <param name="ohs.name"  value="cp1"/>
     </antcall>

  </target>

  <!-- =================================================== -->
  <!-- setupCattleprod -->
  <!-- =================================================== -->
  <target name="setupCattleprod">
  <description>
     All initial setup of cattleprod tests
  </description>

     <!-- Create cgi-bin/cattleprod -->
     <property name="cattleprod.dir" 
               value="${ohsConfDir}/instances/cp1/cgi-bin/cattleprod"/>
     <mkdir dir="${cattleprod.dir}"/>

     <!-- Copy cgi files to cattleprod and instantiate -->
     <antcall target="instantiateCGI">
       <param name="logFile" value="testcgiCookie1.cgi"/>
     </antcall> 
     <antcall target="instantiateCGI">
       <param name="logFile" value="testcgiCookie2.cgi"/>
     </antcall>
     <antcall target="instantiateCGI">
       <param name="logFile" value="testcgiMeta1.cgi"/>
     </antcall>
     <antcall target="instantiateCGI">
       <param name="logFile" value="testcgiMeta2.cgi"/>
     </antcall>
     <antcall target="instantiateCGI">
       <param name="logFile" value="testcgiMeta3.cgi"/>
     </antcall>

  </target>

  <!-- =================================================== -->
  <!-- instantiateCGI -->
  <!-- =================================================== -->
  <target name="instantiateCGI">
  <description>
    Copy given file to cgi-bin/cattleprod and instantiate it.
    Also make the file executable.
    Params:
      ${logFile}  - file to instantiate - expected in T_WORK
  </description>

      <property name="cattleprod.dir"
                value="${ohsConfDir}/instances/cp1/cgi-bin/cattleprod"/>

      <copy file="${tiapcp.base.dir}/common/cgi/${logFile}"
            todir="${cattleprod.dir}"/>
      <replaceregexp file="${cattleprod.dir}/${logFile}"
           match="%APACHE_PERL_BIN%"
           replace="${OHS_PERL_BIN}"
           byline="true"
      />
      <chmod file="${cattleprod.dir}/${logFile}" perm="755"/>
  </target>
</project>
